[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 500
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "5s"
  precision = "1s"
  hostname = "mqtt-ingest"
  omit_hostname = true

[[inputs.mqtt_consumer]]
  servers = ["tcp://${MQTT_BROKER}"]
  topics = ["${MQTT_TELEMETRY_TOPICS}"]
  topic_tag = "topic"
  qos = 0
  username = "${MQTT_USERNAME}"
  password = "${MQTT_PASSWORD}"
  connection_timeout = "30s"
  persistent_session = false
  data_format = "json"
  name_override = "sensor_readings"
  json_time_key = "timestamp"
  json_time_format = "2006-01-02T15:04:05Z07:00"
  tag_keys = ["device_id", "unit", "topic"]
  json_string_fields = ["device_id", "unit"]

[[inputs.mqtt_consumer]]
  servers = ["tcp://${MQTT_BROKER}"]
  topics = ["${MQTT_STATUS_TOPICS}"]
  topic_tag = "topic"
  qos = 0
  username = "${MQTT_USERNAME}"
  password = "${MQTT_PASSWORD}"
  connection_timeout = "30s"
  persistent_session = false
  data_format = "json"
  name_override = "sensor_status"
  tag_keys = ["device_id", "topic"]
  json_string_fields = ["device_id", "status"]

[[processors.enum]]
  namepass = ["sensor_status"]
  [[processors.enum.mapping]]
    field = "status"
    dest = "status_code"
    [processors.enum.mapping.value_mappings]
      ok = 1
      online = 1
      rebooting = 0
      offline = 0
      error = -1

[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "${TELEGRAF_INFLUX_TOKEN}"
  organization = "${TELEGRAF_INFLUX_ORG}"
  bucket = "${TELEGRAF_INFLUX_BUCKET}"
  timeout = "10s"
